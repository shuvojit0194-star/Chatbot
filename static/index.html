<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MCP — Chatbot Interface</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg-void: #0a0a0a;
    --bg-deep: #0f0f0f;
    --bg-panel: #141414;
    --bg-surface: #1c1c1c;
    --bg-elevated: #242424;
    --border-dim: rgba(255,255,255,0.07);
    --border-glow: rgba(255,120,0,0.35);
    --accent-orange: #ff7800;
    --accent-orange-dim: #cc5f00;
    --accent-orange-bright: #ff9a3c;
    --accent-green: #6fcf6f;
    --text-primary: #f0f0f0;
    --text-secondary: #888888;
    --text-muted: #444444;
    --glow-orange: 0 0 20px rgba(255,120,0,0.18), 0 0 60px rgba(255,120,0,0.06);
    --glow-orange-sm: 0 0 12px rgba(255,120,0,0.2);
    --radius-sm: 6px;
    --radius-md: 12px;
    --radius-lg: 18px;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-void);
    color: var(--text-primary);
    font-family: var(--font-mono);
    height: 100vh;
    overflow: hidden;
    display: flex;
  }

  /* ─── Animated grid background ─── */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(255,120,0,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,120,0,0.025) 1px, transparent 1px);
    background-size: 50px 50px;
    pointer-events: none; z-index: 0;
    animation: gridDrift 30s linear infinite;
  }
  @keyframes gridDrift {
    0% { background-position: 0 0; }
    100% { background-position: 50px 50px; }
  }

  /* ─── Ambient orbs ─── */
  .orb {
    position: fixed; border-radius: 50%;
    filter: blur(80px); pointer-events: none; z-index: 0;
    animation: orbPulse 8s ease-in-out infinite alternate;
  }
  .orb-1 { width: 400px; height: 400px; background: rgba(255,120,0,0.07); top: -100px; right: 100px; animation-delay: 0s; }
  .orb-2 { width: 300px; height: 300px; background: rgba(255,90,0,0.05); bottom: 100px; left: 200px; animation-delay: 3s; }
  .orb-3 { width: 200px; height: 200px; background: rgba(150,80,0,0.06); top: 50%; left: 50%; animation-delay: 5s; }
  @keyframes orbPulse { from { opacity: 0.5; transform: scale(1); } to { opacity: 1; transform: scale(1.15); } }

  /* ─── Sidebar ─── */
  .sidebar {
    width: 260px; min-width: 260px;
    background: var(--bg-panel);
    border-right: 1px solid var(--border-dim);
    display: flex; flex-direction: column;
    position: relative; z-index: 10;
    animation: slideInLeft 0.5s cubic-bezier(0.2, 0.8, 0.3, 1) both;
  }
  @keyframes slideInLeft { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  .sidebar-header {
    padding: 24px 20px 20px;
    border-bottom: 1px solid var(--border-dim);
  }
  .logo {
    display: flex; align-items: center; gap: 10px;
    font-family: var(--font-display); font-weight: 800;
    font-size: 16px; letter-spacing: -0.3px;
  }
  .logo-icon {
    width: 32px; height: 32px; border-radius: 8px;
    background: linear-gradient(135deg, var(--accent-orange-dim), var(--accent-orange));
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; box-shadow: var(--glow-orange-sm);
    position: relative; overflow: hidden;
  }
  .logo-icon::after {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
  }
  .logo-text { color: var(--text-primary); }
  .logo-badge {
    margin-left: auto;
    font-size: 9px; font-family: var(--font-mono); font-weight: 500;
    color: var(--accent-orange); background: rgba(255,120,0,0.08);
    border: 1px solid rgba(255,120,0,0.25);
    padding: 2px 6px; border-radius: 4px; letter-spacing: 1px;
  }

  .new-chat-btn {
    margin: 16px 20px 0;
    padding: 10px 14px;
    background: var(--bg-surface);
    border: 1px solid var(--border-dim);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-family: var(--font-mono); font-size: 12px;
    cursor: pointer; display: flex; align-items: center; gap: 8px;
    transition: all 0.2s ease;
    width: calc(100% - 40px);
  }
  .new-chat-btn:hover {
    border-color: var(--border-glow);
    color: var(--accent-orange);
    background: rgba(255,120,0,0.05);
    box-shadow: var(--glow-orange);
  }
  .new-chat-btn svg { opacity: 0.6; transition: opacity 0.2s; }
  .new-chat-btn:hover svg { opacity: 1; }

  .sidebar-section { padding: 20px 20px 8px; }
  .sidebar-label {
    font-size: 9px; letter-spacing: 2px; font-weight: 500;
    color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px;
  }

  .chat-history { flex: 1; overflow-y: auto; padding: 0 12px 12px; }
  .chat-history::-webkit-scrollbar { width: 3px; }
  .chat-history::-webkit-scrollbar-track { background: transparent; }
  .chat-history::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 2px; }

  .chat-item {
    padding: 9px 10px; border-radius: var(--radius-sm);
    cursor: pointer; transition: all 0.15s ease;
    margin-bottom: 2px; display: flex; align-items: center; gap: 8px;
  }
  .chat-item:hover { background: var(--bg-surface); }
  .chat-item.active {
    background: rgba(255,120,0,0.07);
    border: 1px solid rgba(255,120,0,0.2);
  }
  .chat-item-icon { font-size: 12px; opacity: 0.5; flex-shrink: 0; }
  .chat-item-text {
    font-size: 11.5px; color: var(--text-secondary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    transition: color 0.15s;
  }
  .chat-item:hover .chat-item-text, .chat-item.active .chat-item-text { color: var(--text-primary); }
  .chat-item.active .chat-item-icon { opacity: 1; color: var(--accent-orange); }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border-dim);
  }
  .agent-status {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px;
    background: var(--bg-surface); border-radius: var(--radius-md);
    border: 1px solid var(--border-dim);
  }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--accent-green);
    box-shadow: 0 0 6px var(--accent-green);
    animation: pulse-dot 2s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px var(--accent-green); }
    50% { opacity: 0.6; box-shadow: 0 0 12px var(--accent-green); }
  }
  .status-info { flex: 1; }
  .status-name { font-size: 11px; font-weight: 500; color: var(--text-primary); }
  .status-label { font-size: 10px; color: var(--accent-orange); margin-top: 1px; }

  /* ─── Main Chat Area ─── */
  .main {
    flex: 1; display: flex; flex-direction: column;
    position: relative; z-index: 5; min-width: 0;
  }

  .chat-topbar {
    height: 60px; border-bottom: 1px solid var(--border-dim);
    padding: 0 28px; display: flex; align-items: center; justify-content: space-between;
    background: rgba(8,11,16,0.8); backdrop-filter: blur(20px);
    animation: fadeDown 0.4s ease both 0.1s;
  }
  @keyframes fadeDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

  .topbar-title {
    font-family: var(--font-display); font-weight: 700; font-size: 15px;
    display: flex; align-items: center; gap: 10px;
  }
  .topbar-title span { color: var(--text-secondary); font-weight: 400; font-size: 13px; }
  .topbar-actions { display: flex; align-items: center; gap: 8px; }
  .icon-btn {
    width: 34px; height: 34px; border-radius: var(--radius-sm);
    border: 1px solid var(--border-dim);
    background: var(--bg-surface);
    color: var(--text-muted); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; font-size: 14px;
  }
  .icon-btn:hover { border-color: var(--border-glow); color: var(--accent-orange); background: rgba(255,120,0,0.05); }

  /* ─── Messages ─── */
  .messages-wrap {
    flex: 1; overflow-y: auto; padding: 28px;
    display: flex; flex-direction: column; gap: 24px;
  }
  .messages-wrap::-webkit-scrollbar { width: 4px; }
  .messages-wrap::-webkit-scrollbar-track { background: transparent; }
  .messages-wrap::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 2px; }

  .message { display: flex; gap: 14px; animation: msgIn 0.35s cubic-bezier(0.2, 0.8, 0.3, 1) both; }
  @keyframes msgIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  .message.user { flex-direction: row-reverse; }

  .avatar {
    width: 34px; height: 34px; border-radius: 10px;
    flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 600; position: relative;
  }
  .avatar.agent {
    background: linear-gradient(135deg, rgba(255,120,0,0.25), rgba(200,80,0,0.15));
    border: 1px solid rgba(255,120,0,0.3);
    box-shadow: 0 0 16px rgba(255,120,0,0.12);
  }
  .avatar.user {
    background: linear-gradient(135deg, rgba(80,80,80,0.4), rgba(50,50,50,0.3));
    border: 1px solid rgba(255,255,255,0.12);
  }

  .msg-content { max-width: 680px; }
  .msg-meta {
    font-size: 10px; color: var(--text-muted); margin-bottom: 6px;
    display: flex; align-items: center; gap: 8px;
  }
  .message.user .msg-meta { justify-content: flex-end; }
  .msg-name { font-weight: 500; color: var(--text-secondary); }

  .bubble {
    padding: 14px 18px; border-radius: var(--radius-lg);
    font-size: 13.5px; line-height: 1.7;
    position: relative;
  }
  .bubble.agent {
    background: var(--bg-surface);
    border: 1px solid var(--border-dim);
    border-top-left-radius: 4px;
    color: var(--text-primary);
  }
  .bubble.agent::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, var(--accent-orange), transparent);
    opacity: 0.5; border-radius: inherit;
  }
  .bubble.user {
    background: linear-gradient(135deg, rgba(255,120,0,0.12), rgba(180,70,0,0.07));
    border: 1px solid rgba(255,120,0,0.18);
    border-top-right-radius: 4px;
    color: var(--text-primary);
  }

  /* ─── Agent Thinking ─── */
  .thinking-card {
    display: flex; gap: 14px;
    animation: msgIn 0.35s cubic-bezier(0.2, 0.8, 0.3, 1) both;
  }
  .thinking-body {
    background: var(--bg-panel);
    border: 1px solid rgba(255,120,0,0.12);
    border-radius: var(--radius-lg); border-top-left-radius: 4px;
    padding: 14px 18px; min-width: 220px;
    position: relative; overflow: hidden;
  }
  .thinking-body::before {
    content: '';
    position: absolute; left: 0; top: 0; bottom: 0; width: 2px;
    background: linear-gradient(180deg, var(--accent-orange), var(--accent-orange-dim));
    animation: thinkingBar 1.5s ease-in-out infinite alternate;
  }
  @keyframes thinkingBar { from { opacity: 0.4; } to { opacity: 1; } }

  .thinking-label {
    font-size: 10px; color: var(--accent-orange); letter-spacing: 2px; text-transform: uppercase;
    margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
  }
  .thinking-steps { display: flex; flex-direction: column; gap: 6px; }
  .thinking-step {
    display: flex; align-items: center; gap: 8px;
    font-size: 11.5px; color: var(--text-secondary);
  }
  .step-icon {
    width: 16px; height: 16px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 8px; flex-shrink: 0;
  }
  .step-icon.done { background: rgba(111,207,111,0.15); color: var(--accent-green); }
  .step-icon.active {
    background: rgba(255,120,0,0.1);
    border: 1px solid rgba(255,120,0,0.4);
    animation: spinStep 1s linear infinite;
  }
  .step-icon.active::after { content: '○'; color: var(--accent-orange); }
  @keyframes spinStep { from { rotate: 0deg; } to { rotate: 360deg; } }
  .step-icon.pending { background: rgba(255,255,255,0.04); color: var(--text-muted); }

  .thinking-dots { display: flex; gap: 4px; align-items: center; margin-top: 12px; }
  .dot {
    width: 5px; height: 5px; border-radius: 50%;
    background: var(--accent-orange); opacity: 0.3;
    animation: dotBounce 1.2s ease-in-out infinite;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; background: var(--accent-orange-bright); }
  .dot:nth-child(3) { animation-delay: 0.4s; background: #ffffff; }
  @keyframes dotBounce { 0%, 80%, 100% { opacity: 0.3; transform: scaleY(1); } 40% { opacity: 1; transform: scaleY(1.5); } }

  /* ─── Welcome screen ─── */
  .welcome {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center; padding: 40px;
    animation: fadeIn 0.6s ease both 0.2s;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  .welcome-orb {
    width: 90px; height: 90px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent-orange-dim), var(--accent-orange));
    display: flex; align-items: center; justify-content: center;
    font-size: 36px; margin-bottom: 28px;
    box-shadow: 0 0 50px rgba(255,120,0,0.2), 0 0 100px rgba(255,120,0,0.07);
    animation: welcomeFloat 4s ease-in-out infinite;
    position: relative;
  }
  .welcome-orb::after {
    content: ''; position: absolute; inset: -8px; border-radius: 50%;
    border: 1px solid rgba(255,120,0,0.25);
    animation: ringPulse 3s ease-in-out infinite;
  }
  @keyframes welcomeFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  @keyframes ringPulse { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 0.2; } }

  .welcome h1 {
    font-family: var(--font-display); font-weight: 800; font-size: 32px;
    letter-spacing: -1px; margin-bottom: 10px;
    background: linear-gradient(135deg, #ffffff 30%, var(--accent-orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .welcome p { font-size: 13px; color: var(--text-secondary); max-width: 400px; line-height: 1.8; margin-bottom: 32px; }

  .suggestions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
  .suggestion-chip {
    padding: 9px 16px; font-size: 12px;
    background: var(--bg-surface); border: 1px solid var(--border-dim);
    border-radius: 40px; cursor: pointer; color: var(--text-secondary);
    font-family: var(--font-mono); transition: all 0.2s ease;
    display: flex; align-items: center; gap: 6px;
  }
  .suggestion-chip:hover {
    border-color: var(--border-glow); color: var(--accent-orange);
    background: rgba(255,120,0,0.06); transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(255,120,0,0.1);
  }

  /* ─── Input Area ─── */
  .input-area {
    padding: 16px 28px 22px;
    background: linear-gradient(0deg, var(--bg-deep) 70%, transparent);
  }
  .input-container {
    background: var(--bg-surface);
    border: 1px solid var(--border-dim);
    border-radius: 16px; padding: 14px 16px;
    display: flex; align-items: flex-end; gap: 12px;
    transition: all 0.2s ease; position: relative; overflow: hidden;
  }
  .input-container::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(0,200,255,0.02), transparent);
    pointer-events: none;
  }
  .input-container:focus-within {
    border-color: rgba(255,120,0,0.3);
    box-shadow: 0 0 0 3px rgba(255,120,0,0.06), var(--glow-orange);
  }
  .input-field {
    flex: 1; background: transparent; border: none; outline: none;
    color: var(--text-primary); font-family: var(--font-mono); font-size: 13.5px;
    resize: none; max-height: 160px; min-height: 22px; line-height: 1.6;
  }
  .input-field::placeholder { color: var(--text-muted); }

  .send-btn {
    width: 36px; height: 36px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent-orange-dim), var(--accent-orange));
    border: none; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s ease; box-shadow: var(--glow-orange-sm);
    font-size: 14px; color: white;
  }
  .send-btn:hover { transform: scale(1.08); box-shadow: 0 0 24px rgba(255,120,0,0.35); }
  .send-btn:active { transform: scale(0.96); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .input-meta {
    display: flex; align-items: center; justify-content: space-between;
    margin-top: 10px; padding: 0 2px;
  }
  .input-hints { font-size: 10.5px; color: var(--text-muted); display: flex; align-items: center; gap: 12px; }
  .hint-key {
    background: var(--bg-elevated); border: 1px solid var(--border-dim);
    padding: 2px 5px; border-radius: 3px; font-size: 9px; color: var(--text-muted);
  }
  .char-count { font-size: 10px; color: var(--text-muted); }

  /* ─── Scan line effect ─── */
  .scanline {
    position: fixed; inset: 0; pointer-events: none; z-index: 100;
    background: repeating-linear-gradient(
      0deg,
      rgba(0,0,0,0.03) 0px,
      rgba(0,0,0,0.03) 1px,
      transparent 1px,
      transparent 2px
    );
  }

  /* scrollbar global */
  * { scrollbar-width: thin; scrollbar-color: var(--text-muted) transparent; }
</style>
</head>
<body>

<!-- Ambient -->
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>
<div class="orb orb-3"></div>
<div class="scanline"></div>

<!-- ─── Sidebar ─── -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <div class="logo-icon">⬡</div>
      <span class="logo-text">MCP</span>
      <span class="logo-badge">BOT</span>
    </div>
    <button class="new-chat-btn" onclick="newChat()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Session
    </button>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-label">Recent Sessions</div>
  </div>

  <div class="chat-history" id="chatHistory">
    <div class="chat-item active">
      <span class="chat-item-icon">◈</span>
      <span class="chat-item-text">Analyze Q3 sales data</span>
    </div>
    <div class="chat-item">
      <span class="chat-item-icon">◈</span>
      <span class="chat-item-text">Summarize research paper</span>
    </div>
    <div class="chat-item">
      <span class="chat-item-icon">◈</span>
      <span class="chat-item-text">Generate SQL schema</span>
    </div>
    <div class="chat-item">
      <span class="chat-item-icon">◈</span>
      <span class="chat-item-text">Debug Python script</span>
    </div>
    <div class="chat-item">
      <span class="chat-item-icon">◈</span>
      <span class="chat-item-text">Web scraping plan</span>
    </div>
    <div class="chat-item">
      <span class="chat-item-icon">◈</span>
      <span class="chat-item-text">Market research brief</span>
    </div>
  </div>

  <div class="sidebar-footer">
    <div class="agent-status">
      <div class="status-dot"></div>
      <div class="status-info">
        <div class="status-name">MCP Chatbot v2.4.1</div>
        <div class="status-label">Online · Ready</div>
      </div>
      <span style="font-size:12px;color:var(--text-muted);">⚙</span>
    </div>
  </div>
</aside>

<!-- ─── Main ─── -->
<main class="main">
  <div class="chat-topbar">
    <div class="topbar-title">
      MCP Chatbot <span>/ Analyze Q3 sales data</span>
    </div>
    <div class="topbar-actions">
      <button class="icon-btn" title="Clear chat" onclick="clearChat()">⊘</button>
      <button class="icon-btn" title="Export">↗</button>
      <button class="icon-btn" title="Settings">⚙</button>
    </div>
  </div>

  <div class="messages-wrap" id="messages">
    <!-- Welcome state shown initially -->
    <div class="welcome" id="welcomeState">
      <div class="welcome-orb">⬡</div>
      <h1>MCP Chatbot</h1>
      <p>An autonomous AI-powered chatbot ready to reason, plan, and execute. Ask anything — it thinks step by step before responding.</p>
      <div class="suggestions">
        <div class="suggestion-chip" onclick="sendSuggestion(this)">⬡ Analyze a dataset</div>
        <div class="suggestion-chip" onclick="sendSuggestion(this)">◈ Generate a report</div>
        <div class="suggestion-chip" onclick="sendSuggestion(this)">⧉ Debug my code</div>
        <div class="suggestion-chip" onclick="sendSuggestion(this)">⊕ Plan a strategy</div>
        <div class="suggestion-chip" onclick="sendSuggestion(this)">◑ Summarize a document</div>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-container">
      <textarea
        class="input-field"
        id="inputField"
        rows="1"
        placeholder="Send a message to MCP Chatbot..."
        onkeydown="handleKey(event)"
        oninput="autoResize(this); updateCharCount(this);"
      ></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="input-meta">
      <div class="input-hints">
        <span><span class="hint-key">Enter</span> Send</span>
        <span><span class="hint-key">Shift+Enter</span> New line</span>
      </div>
      <div class="char-count" id="charCount">0 / 2000</div>
    </div>
  </div>
</main>

<script>
  // ─────────────────────────────────────────────────────────────
  //  ⚙️  CONFIGURATION
  //  After running the Colab cell, paste your ngrok URL below.
  //  Example: "https://a1b2-34-56-78-90.ngrok-free.app"
  // ─────────────────────────────────────────────────────────────
  // On Cloud Run, the UI is served by the same server as the API.
  // An empty string means "same origin" — no URL needed!
  const API_BASE_URL = "";

  // ─────────────────────────────────────────────────────────────

  let isThinking = false;
  let msgCount = 0;
  let sessionId = "session_" + Date.now();

  const thinkingScenarios = [
    ["Parsing your request", "Querying knowledge base", "Formulating response"],
    ["Understanding context", "Running sub-tasks", "Synthesizing output"],
    ["Breaking down the problem", "Gathering relevant data", "Constructing answer"],
    ["Analyzing requirements", "Planning execution steps", "Generating response"],
  ];

  // ── Connection status banner ──────────────────────────────────
  async function checkConnection() {
    try {
      const res = await fetch(`${API_BASE_URL}/health`, { method: "GET" });
      if (res.ok) {
        setStatus("online");
      } else {
        setStatus("error");
      }
    } catch {
      setStatus("offline");
    }
  }

  function setStatus(state) {
    const dot  = document.querySelector('.status-dot');
    const label = document.querySelector('.status-label');
    if (state === "online")  { dot.style.background = "var(--accent-green)"; dot.style.boxShadow = "0 0 6px var(--accent-green)"; label.textContent = "Online · Ready"; label.style.color = "var(--accent-green)"; }
    if (state === "offline") { dot.style.background = "#ff4444"; dot.style.boxShadow = "0 0 6px #ff4444"; label.textContent = "Offline — start Colab"; label.style.color = "#ff4444"; }
    if (state === "error")   { dot.style.background = "var(--accent-orange)"; label.textContent = "Connected · Error"; label.style.color = "var(--accent-orange)"; }
  }

  // Check on load, then every 30s
  checkConnection();
  setInterval(checkConnection, 30000);

  // ─────────────────────────────────────────────────────────────

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
  }

  function updateCharCount(el) {
    document.getElementById('charCount').textContent = `${el.value.length} / 2000`;
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  }

  function hideWelcome() {
    const w = document.getElementById('welcomeState');
    if (w) { w.style.animation = 'fadeOut 0.2s ease forwards'; setTimeout(() => w.remove(), 200); }
  }

  function sendSuggestion(el) {
    const text = el.textContent.replace(/^[⬡◈⧉⊕◑] /, '');
    document.getElementById('inputField').value = text;
    sendMessage();
  }

  async function sendMessage() {
    const field = document.getElementById('inputField');
    const text = field.value.trim();
    if (!text || isThinking) return;
    field.value = ''; field.style.height = 'auto';
    document.getElementById('charCount').textContent = '0 / 2000';
    hideWelcome();
    appendUserMessage(text);
    addToHistory(text);

    const thinkingDone = showThinking();

    try {
      const response = await fetch(`${API_BASE_URL}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text, session_id: sessionId }),
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const data = await response.json();
      await thinkingDone;                        // wait for animation to finish
      removeThinking();
      appendAgentMessage(data.reply);

    } catch (err) {
      await thinkingDone;
      removeThinking();
      appendAgentMessage(
        `⚠️ Could not reach the MCP backend.<br>
        <small style="color:var(--text-muted)">
          Make sure your Colab cell is running and <code>API_BASE_URL</code> is set correctly.<br>
          Error: ${escapeHtml(err.message)}
        </small>`
      );
    }
  }

  function appendUserMessage(text) {
    msgCount++;
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const div = document.createElement('div');
    div.className = 'message user';
    div.innerHTML = `
      <div class="avatar user">U</div>
      <div class="msg-content">
        <div class="msg-meta"><span class="msg-name">You</span><span>${time}</span></div>
        <div class="bubble user">${escapeHtml(text)}</div>
      </div>`;
    document.getElementById('messages').appendChild(div);
    scrollToBottom();
  }

  // Returns a Promise that resolves after the thinking animation completes
  function showThinking() {
    isThinking = true;
    document.getElementById('sendBtn').disabled = true;
    const steps = thinkingScenarios[Math.floor(Math.random() * thinkingScenarios.length)];
    const card = document.createElement('div');
    card.className = 'thinking-card'; card.id = 'thinkingCard';
    card.innerHTML = `
      <div class="avatar agent">⬡</div>
      <div>
        <div class="msg-meta"><span class="msg-name">MCP Chatbot</span><span>thinking...</span></div>
        <div class="thinking-body">
          <div class="thinking-label"><span>◈</span> Processing</div>
          <div class="thinking-steps" id="thinkSteps">
            ${steps.map((s, i) => `
              <div class="thinking-step" id="step-${i}">
                <div class="step-icon pending">○</div>
                <span>${s}</span>
              </div>`).join('')}
          </div>
          <div class="thinking-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>
      </div>`;
    document.getElementById('messages').appendChild(card);
    scrollToBottom();

    return new Promise(resolve => {
      let idx = 0;
      const advance = () => {
        if (idx < steps.length) {
          const step = document.getElementById(`step-${idx}`);
          if (step) { step.querySelector('.step-icon').className = 'step-icon active'; step.querySelector('.step-icon').textContent = ''; }
          if (idx > 0) {
            const prev = document.getElementById(`step-${idx - 1}`);
            if (prev) { prev.querySelector('.step-icon').className = 'step-icon done'; prev.querySelector('.step-icon').textContent = '✓'; }
          }
          idx++;
          setTimeout(advance, 600 + Math.random() * 400);
        } else {
          const prev = document.getElementById(`step-${idx - 1}`);
          if (prev) { prev.querySelector('.step-icon').className = 'step-icon done'; prev.querySelector('.step-icon').textContent = '✓'; }
          setTimeout(resolve, 400);
        }
      };
      setTimeout(advance, 300);
    });
  }

  function removeThinking() {
    const card = document.getElementById('thinkingCard');
    if (card) card.remove();
    isThinking = false;
    document.getElementById('sendBtn').disabled = false;
  }

  function appendAgentMessage(text) {
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const div = document.createElement('div');
    div.className = 'message';
    div.innerHTML = `
      <div class="avatar agent">⬡</div>
      <div class="msg-content">
        <div class="msg-meta"><span class="msg-name">MCP Chatbot</span><span>${time}</span></div>
        <div class="bubble agent">${text}</div>
      </div>`;
    document.getElementById('messages').appendChild(div);
    scrollToBottom();
  }

  function addToHistory(text) {
    const history = document.getElementById('chatHistory');
    const existing = history.querySelector('.chat-item.active');
    if (existing) existing.classList.remove('active');
    const item = document.createElement('div');
    item.className = 'chat-item active';
    item.innerHTML = `<span class="chat-item-icon">◈</span><span class="chat-item-text">${escapeHtml(text)}</span>`;
    history.insertBefore(item, history.firstChild);
  }

  function newChat() {
    sessionId = "session_" + Date.now();  // fresh session for memory isolation
    const msgs = document.getElementById('messages');
    msgs.innerHTML = `
      <div class="welcome" id="welcomeState">
        <div class="welcome-orb">⬡</div>
        <h1>MCP Chatbot</h1>
        <p>An autonomous AI-powered chatbot ready to reason, plan, and execute. Ask anything — it thinks step by step before responding.</p>
        <div class="suggestions">
          <div class="suggestion-chip" onclick="sendSuggestion(this)">⬡ Analyze a dataset</div>
          <div class="suggestion-chip" onclick="sendSuggestion(this)">◈ Generate a report</div>
          <div class="suggestion-chip" onclick="sendSuggestion(this)">⧉ Debug my code</div>
          <div class="suggestion-chip" onclick="sendSuggestion(this)">⊕ Plan a strategy</div>
          <div class="suggestion-chip" onclick="sendSuggestion(this)">◑ Summarize a document</div>
        </div>
      </div>`;
    document.querySelector('.topbar-title').innerHTML = 'MCP Chatbot <span>/ New Session</span>';
    document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
  }

  function clearChat() { newChat(); }

  function scrollToBottom() {
    const wrap = document.getElementById('messages');
    setTimeout(() => wrap.scrollTop = wrap.scrollHeight, 50);
  }

  function escapeHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }

  const style = document.createElement('style');
  style.textContent = `@keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }`;
  document.head.appendChild(style);
</script>
</body>
</html>
